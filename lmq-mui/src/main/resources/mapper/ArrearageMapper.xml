<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lmq.dao.report.ArrearageMapper">
  <resultMap id="Arrearage" type="com.lmq.domain.report.Arrearage">
    <id column="id" property="id" />
    <result column="name" property="name" />
    <result column="initMoney" property="initMoney" />
    <result column="addMoney" property="addMoney" />
    <result column="backMoney" property="backMoney" />
    <result column="finalMoney" property="finalMoney" />
    <result column="time" property="time" />
    <result column="reason" property="reason"/>
    <result column="bh" property="bh"/>
  </resultMap>

  <select id="queryReceipt" resultMap="Arrearage">
  	SELECT customer.`Name` AS `name`,a.cid AS id,SUM(b.money) AS initMoney,SUM(a.addMoney) AS addMoney,SUM(a.backMoney) AS backMoney 
	FROM customer LEFT JOIN
	(SELECT `cid`,`money` AS addMoney,NULL AS backMoney FROM sales WHERE `time` BETWEEN #{starttime} AND #{endtime} AND `status`=0
	UNION ALL
	SELECT `cid`,NULL AS addMoney,`money` AS backMoney FROM customerrecharge WHERE `time` BETWEEN #{starttime} AND #{endtime} AND `status`=0
	) AS a ON a.cid=customer.`Id`
	LEFT JOIN (SELECT sales.`cid`,(sales.`Takeinmoney`+sales.`deposi`) AS money FROM sales WHERE `time` &lt; #{starttime} AND `status`=0
	UNION ALL
	SELECT cid,money FROM customerrecharge  WHERE `time` &lt; #{starttime} AND `status`=0
	) AS b ON b.cid=customer.`Id`
	GROUP BY a.cid
  </select>
  <select id="queryReceiptDetail" resultMap="Arrearage">
	SELECT customer.`Name` AS `name`,a.*,c.* FROM customer
	LEFT JOIN (
	SELECT `cid` AS id,'销售出货' AS `reason`,sales.`user1` AS bh,`money` AS addMoney,NULL AS backMoney,sales.`time` FROM sales WHERE `time` BETWEEN #{starttime} AND #{endtime} AND `status`=0
	UNION ALL
	SELECT `cid`,'收款' AS `reason`,customerrecharge.`user1` AS bh,NULL AS addMoney,`money` AS backMoney,customerrecharge.`Time` AS `time` FROM customerrecharge WHERE `time` BETWEEN #{starttime} AND #{endtime} AND `status`=0
	) AS a ON a.id=customer.`Id`
	LEFT JOIN (
	SELECT (SELECT SUM(sales.`Takeinmoney`+sales.`deposi`) FROM sales WHERE `time` &lt; #{starttime} AND `status`=0 AND sales.`cid`=#{cid})
	+(SELECT SUM(money) FROM customerrecharge  WHERE `time` &lt; #{starttime} AND `status`=0 AND customerrecharge.`cid`=#{cid}) AS initMoney
	) AS c ON 1=1
	WHERE customer.`Id`=#{cid}
	ORDER BY `time`
  </select>
  <select id="queryPay" resultMap="Arrearage">
select * from customer
  </select>
  <select id="queryPayDetail" resultMap="Arrearage">
select * from customer
  </select>
</mapper>