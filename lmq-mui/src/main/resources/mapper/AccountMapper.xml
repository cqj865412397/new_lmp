<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lmq.dao.report.AccountMapper">
  <resultMap id="Account" type="com.lmq.domain.report.Account">
    <result column="id" property="id" />
    <result column="name" property="name" />
    <result column="lx" property="lx" />
    <result column="bh" property="bh"/>
    <result column="time" property="time" />
    <result column="initMoney" property="initMoney" />
    <result column="addMoney" property="addMoney" />
    <result column="backMoney" property="backMoney" />
    <result column="finalMoney" property="finalMoney" />
    <collection property="list" ofType="com.lmq.domain.report.EasyGoods">
    	<id column="gid" property="gid"/>
    	<result column="gname" property="gname"/>
    	<result column="num" property="num"/>
    	<result column="price" property="price"/>
    	<result column="money" property="money"/>
    </collection>
  </resultMap>

  <select id="queryReceipt" resultMap="Account">
	
	SELECT customer.`Name` AS `name`,a.*,c.* FROM customer
	LEFT JOIN (
	SELECT sales.`cid` AS id,'销售出货' AS `lx`,sales.`user1` AS bh,sales.`user5` AS addMoney,sales.`Takeinmoney` AS backMoney,sales.`time`,goodsinstance.`Id` AS gid,CONCAT(goods.`name`,t.standardName) AS gname,salesdetails.`count` AS num,salesdetails.`Takeinmoney` AS `money` FROM sales 
	LEFT JOIN salesdetails ON salesdetails.`Salesid`=sales.`Id`
	LEFT JOIN goodsinstance ON goodsinstance.`Id`=salesdetails.`user1`
	LEFT JOIN goods ON goods.`Id`=goodsinstance.`Gid`
	LEFT JOIN (
		SELECT goodsinstance.Id,GROUP_CONCAT(standardinstance.`Name`)AS standardName FROM goodsinstance 
		LEFT JOIN standardinstance ON FIND_IN_SET(standardinstance.`Id` , goodsinstance.`ids`)
		GROUP BY goodsinstance.`Id`
	) AS t ON t.Id=goodsinstance.`Id`
	WHERE sales.`time` BETWEEN #{startdate} AND #{enddate} AND sales.`status`=0
	UNION ALL
	SELECT `cid`,'收款' AS `lx`,customerrecharge.`user2` AS bh,NULL AS addMoney,`money` AS backMoney,customerrecharge.`Time` AS `time`,NULL AS gid,NULL AS gname,NULL AS num,NULL AS `money` FROM customerrecharge WHERE `time` BETWEEN #{startdate} AND #{enddate} AND `status`=0
	) AS a ON a.id=customer.`Id`
	LEFT JOIN (
	SELECT (SELECT SUM(sales.`user5`) FROM sales WHERE `time` &lt; #{startdate} AND `status`=0 AND sales.`cid`=#{customer})
	+(SELECT SUM(money) FROM customerrecharge  WHERE `time` &lt; #{startdate} AND `status`=0 AND customerrecharge.`cid`=#{customer}) AS initMoney
	) AS c ON 1=1
	WHERE customer.`Id`=#{customer}
	ORDER BY `time`
  </select>
  <select id="queryPay" resultMap="Account">
	SELECT su.`Name` AS `name`,a.*,b.initMoney FROM supplier AS su
	LEFT JOIN (
	SELECT Supid AS id,'进货' AS `lx`,stock.`Code` AS bh,`Allprice` AS addMoney,stock.`Time` AS `time` FROM stock
	WHERE `Time` BETWEEN #{startdate} AND #{enddate} AND `status`=0
	) AS a ON su.`Id`=a.id
	LEFT JOIN (
	SELECT Supid,SUM(`Allprice`) AS initMoney FROM stock
	WHERE `Time` &lt; #{startdate} AND `status`=0 AND stock.`Supid`=#{supplier}
	) AS b ON su.`Id`=b.Supid
	WHERE su.`Id`=#{supplier}
  </select>
</mapper>